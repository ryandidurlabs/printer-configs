# Klipper Configuration for CR-10S Printer 1
# Modified: Direct Drive, 0.8mm Nozzle, Filament Sensor
# Control Board: [UPDATE WITH YOUR BOARD TYPE]

# ============================================================================
# MCU Configuration
# ============================================================================
[mcu]
serial: /dev/ttyUSB0
baud: 115200
restart_method: command

# ============================================================================
# Stepper Motors
# ============================================================================

[stepper_x]
step_pin: PB9
dir_pin: PC2
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: 0
position_max: 300
homing_speed: 50

[stepper_y]
step_pin: PB7
dir_pin: PB8
enable_pin: !PC3
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: 0
position_max: 300
homing_speed: 50

[stepper_z]
step_pin: PB5
dir_pin: !PB6
enable_pin: !PC3
microsteps: 16
rotation_distance: 8
endstop_pin: probe:z_virtual_endstop
position_max: 400
position_min: -1.8

# ============================================================================
# Extruder (Direct Drive)
# ============================================================================
[extruder]
max_extrude_only_distance: 100.0
step_pin: PB3
dir_pin: PB4
enable_pin: !PC3
microsteps: 16
gear_ratio: 42:12
rotation_distance: 26.619
nozzle_diameter: 0.800
filament_diameter: 1.750
heater_pin: PA1
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC5
control: pid
pid_Kp: 22.283
pid_Ki: 1.338
pid_Kd: 92.752
min_temp: 0
max_temp: 300

# ============================================================================
# Bed Heater
# ============================================================================
[heater_bed]
heater_pin: PA2
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC4
control: pid
pid_Kp: 74.012
pid_Ki: 0.782
pid_Kd: 1751.305
min_temp: 0
max_temp: 130

# ============================================================================
# Fan Configuration
# ============================================================================
# Part cooling fan (controlled by slicer)
[fan]
pin: PA0
# Cooling fan speed (0-1)
max_power: 1.0
kick_start_time: 0.5
off_below: 0.0

# Hotend cooling fan (always on when hotend is hot)
[heater_fan hotend_fan]
pin: PA8
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

# ============================================================================
# BLTouch Probe
# ============================================================================
[bltouch]
sensor_pin: ^PB1
control_pin: PB0
x_offset: 31.8
y_offset: 40.5
#z_offset: 1.759
speed: 20
samples: 4
sample_retract_dist: 10.0
stow_on_each_sample: true
pin_up_reports_not_triggered: False

[safe_z_home]
home_xy_position: 150,150
speed: 200
z_hop: 15
z_hop_speed: 40

# ============================================================================
# Display
# ============================================================================
[display]
lcd_type: st7920
cs_pin: PB12
sclk_pin: PB13
sid_pin: PB15
encoder_pins: ^PB14, ^PB10
click_pin: ^!PB2

# ============================================================================
# Filament Sensor
# ============================================================================
[filament_switch_sensor RunoutSensor]
pause_on_runout: False
switch_pin: PA4
runout_gcode: FILAMENT_RUNOUT
insert_gcode: FILAMENT_INSERTED

# ============================================================================
# Board Pins Aliases
# ============================================================================
[board_pins]
aliases:
  EXP1_1=PC6,EXP1_3=PB10,EXP1_5=PB14,EXP1_7=PB12,EXP1_9=<GND>,
  EXP1_2=PB2,EXP1_4=PB11,EXP1_6=PB13,EXP1_8=PB15,EXP1_10=<5V>,
  PROBE_IN=PB0,PROBE_OUT=PB1,FIL_RUNOUT=PA4

# ============================================================================
# Bed Leveling (BLTouch Mesh)
# ============================================================================
[bed_mesh]
speed: 190
mesh_min: 10,20
mesh_max: 255,250
probe_count: 4,4
horizontal_move_z: 10
fade_start: 1
fade_end: 10
fade_target: 0
algorithm: bicubic
move_check_distance: 5
split_delta_z: .025
adaptive_margin: 5

# ============================================================================
# Display (if you have one)
# ============================================================================
# Uncomment if you have a display connected
# [display]
# lcd_type: st7920
# cs_pin: EXP1_7
# sclk_pin: EXP1_6
# sid_pin: EXP1_8
# encoder_pins: ^EXP1_5, ^EXP1_3
# click_pin: ^!EXP1_2

# ============================================================================
# Printer Settings
# ============================================================================
[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_z_velocity: 5
max_z_accel: 100

# ============================================================================
# Virtual SD Card
# ============================================================================
[virtual_sdcard]
path: ~/printer_data/gcodes

# ============================================================================
# Filament Runout Macros
# ============================================================================
[gcode_macro FILAMENT_RUNOUT]
description: Safe filament runout pause with gentle park to prevent skipping
gcode:
  M117 Filament Runout
  SAVE_GCODE_STATE NAME=RUNOUT_STATE

  # Small retract to reduce ooze
  M83
  G1 E-3 F1200
  M82

  # Reduce motion aggressiveness for the park move
  SET_VELOCITY_LIMIT VELOCITY=80 ACCEL=800 ACCEL_TO_DECEL=400

  # Z hop, then park to a conservative safe point
  G91
  G1 Z10 F600
  G90

  # SAFE PARK POSITION (adjust if you want)
  G1 X10 Y10 F2400

  PAUSE

[gcode_macro FILAMENT_INSERTED]
description: Optional message when filament is inserted
gcode:
  M117 Filament Inserted

[gcode_macro RESUME]
rename_existing: RESUME_BASE
gcode:
  SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity|float} \
                     ACCEL={printer.configfile.settings.printer.max_accel|float}
  RESTORE_GCODE_STATE NAME=RUNOUT_STATE MOVE=1
  RESUME_BASE

# ============================================================================
# G-Code Macros
# ============================================================================
# Klipper does not support command G29. Define it as a macro.
[gcode_macro G29]
gcode:
  G28 X0 Y0
  G28 Z0
  G0 Z5 F1200
  BED_MESH_CALIBRATE
  BED_MESH_PROFILE SAVE=default
  G28
  SAVE_CONFIG

[gcode_macro START_PRINT]
gcode:
  {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
  {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}

  M104 S{EXTRUDER_TEMP}
  M140 S{BED_TEMP}

  M190 S{BED_TEMP}
  M109 S{EXTRUDER_TEMP}

  {% if 'default' in printer.bed_mesh.profiles %}
    G28
    BED_MESH_PROFILE LOAD=default
    M117 Bed mesh activated
  {% else %}
    G28
    G0 Z5 F1200
    BED_MESH_CALIBRATE
    BED_MESH_PROFILE SAVE=default
    G28
    M117 New bed mesh created and saved
  {% endif %}

  G92 E0
  G1 Z2.0 F3000

[gcode_macro END_PRINT]
gcode:
  M140 S0
  M104 S0
  M106 S0
  G91
  G1 X-2 Y-2 E-3 F300
  G1 Z10 F3000
  G90
  M84

[gcode_macro M92]
gcode:
  M221

# ============================================================================
# Include Macros and Mainsail Config
# ============================================================================
[include macros.cfg]
[include mainsail.cfg]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [bltouch]
#*# z_offset = 1.499
