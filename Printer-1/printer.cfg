# Klipper Configuration for CR-10S Printer 1
# Modified: Direct Drive, 0.8mm Nozzle, Filament Sensor
# Control Board: [UPDATE WITH YOUR BOARD TYPE]

# ============================================================================
# MCU Configuration
# ============================================================================
[mcu]
# Update this serial path - check with: ls /dev/ttyUSB* or ls /dev/ttyACM*
serial: /dev/ttyUSB0
# Baud rate - typically 250000 for most boards
baud: 250000
# Restart method - depends on your board
# restart_method: command

# ============================================================================
# Stepper Motors
# ============================================================================

[stepper_x]
step_pin: PB8
dir_pin: PB7
enable_pin: !PB6
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA5
position_endstop: 0
position_max: 300
homing_speed: 50
homing_retract_dist: 0

[stepper_y]
step_pin: PC2
dir_pin: PB9
enable_pin: !PB5
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA6
position_endstop: 0
position_max: 300
homing_speed: 50
homing_retract_dist: 0

[stepper_z]
step_pin: PB4
dir_pin: PB3
enable_pin: !PA15
microsteps: 16
rotation_distance: 8
endstop_pin: ^PA7
position_endstop: 0.5
position_max: 400
homing_speed: 5
second_homing_speed: 1
homing_retract_dist: 0

# ============================================================================
# Extruder (Direct Drive)
# ============================================================================
[extruder]
step_pin: PC3
dir_pin: PB2
enable_pin: !PB1
microsteps: 16
# Rotation distance for direct drive - CALIBRATE THIS
# Typical range: 20-25mm for most direct drive setups
# Formula: rotation_distance = (motor_steps_per_rev × microsteps) / (gear_ratio × steps_per_mm)
# Start with 22.678 (BMG clone) or adjust based on your extruder
rotation_distance: 22.678
# Nozzle diameter
nozzle_diameter: 0.800
# Filament diameter
filament_diameter: 1.750
# Max extrusion length for safety
max_extrude_only_distance: 200.0
# Pressure advance - tune for your setup
pressure_advance: 0.05
# Max temperature
max_temp: 300
# Heater pin
heater_pin: PA1
# Thermistor type - B3950 for most CR-10S
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC5
# Control parameters - PID tune these
control: pid
pid_Kp: 28.123
pid_Ki: 1.304
pid_Kd: 143.527
# Minimum temperature for extrusion
min_temp: 0
max_extrude_only_distance: 200.0

# ============================================================================
# Bed Heater
# ============================================================================
[heater_bed]
heater_pin: PA2
sensor_type: ATC Semitec 104GT-2
sensor_pin: PC4
control: pid
# PID values - TUNE THESE with PID_CALIBRATE
pid_Kp: 68.789
pid_Ki: 1.304
pid_Kd: 1068.182
min_temp: 0
max_temp: 100

# ============================================================================
# Fan Configuration
# ============================================================================
# Part cooling fan (controlled by slicer)
[fan]
pin: PA0
# Cooling fan speed (0-1)
max_power: 1.0
kick_start_time: 0.5
off_below: 0.0

# Hotend cooling fan (always on when hotend is hot)
[heater_fan hotend_fan]
pin: PA8
heater: extruder
heater_temp: 50.0
fan_speed: 1.0

# ============================================================================
# Filament Sensor
# ============================================================================
# Update pin based on your sensor connection
# Common pins: PA4, PA3, or check your board documentation
[filament_switch_sensor filament_sensor]
switch_pin: PA4
# Pause print when filament runs out
pause_on_runout: True
# Built-in PAUSE and RESUME commands will be used

# ============================================================================
# Bed Leveling (Manual Mesh)
# ============================================================================
[bed_mesh]
speed: 50
horizontal_move_z: 5
mesh_min: 10, 10
mesh_max: 290, 290
probe_count: 5, 5
# Use manual probing (no BLTouch)
algorithm: bicubic

# ============================================================================
# Display (if you have one)
# ============================================================================
# Uncomment if you have a display connected
# [display]
# lcd_type: st7920
# cs_pin: EXP1_7
# sclk_pin: EXP1_6
# sid_pin: EXP1_8
# encoder_pins: ^EXP1_5, ^EXP1_3
# click_pin: ^!EXP1_2

# ============================================================================
# Printer Settings
# ============================================================================
[printer]
kinematics: cartesian
max_velocity: 300
max_accel: 3000
max_accel_to_decel: 1500
max_z_velocity: 5
square_corner_velocity: 5.0

# ============================================================================
# Virtual SD Card
# ============================================================================
[virtual_sdcard]
path: ~/printer_data/gcodes

# ============================================================================
# G-Code Macros
# ============================================================================
[gcode_macro START_PRINT]
gcode:
    # Start print macro
    G28                                    # Home all axes
    G1 Z10 F6000                           # Move Z up
    G92 E0                                  # Reset extruder
    G1 X5 Y5 F6000                         # Move to start position
    G1 Z0.3 F600                           # Move to first layer height
    G1 X10 Y10 E5 F1500                    # Prime line
    G92 E0                                  # Reset extruder again

[gcode_macro END_PRINT]
gcode:
    # End print macro
    M104 S0                                 # Turn off extruder heater
    M140 S0                                 # Turn off bed heater
    G91                                     # Relative positioning
    G1 E-1 F300                             # Retract filament
    G1 Z5 F3000                             # Move Z up
    G90                                     # Absolute positioning
    G1 X0 Y300 F6000                        # Move to front
    M84                                     # Disable steppers

# PAUSE and RESUME are built-in Klipper commands
# Custom pause/resume behavior can be configured via pause_resume section if needed

# ============================================================================
# Include Macros
# ============================================================================
[include macros.cfg]
